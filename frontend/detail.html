<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>D√©tail du covoiturage - ecoCovoit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <!-- Inclure ton header / menu ici (peut √™tre copi√© de index.html) -->
    </header>

    <main>
      <section class="trajet-detail">
        <div class="container">
          <h1><i class="fas fa-route"></i> Paris ‚Üí Lyon</h1>

          <!-- Infos trajet -->
          <div class="trajet-info">
            <div class="info-group">
              <h3><i class="fas fa-info-circle"></i> Informations trajet</h3>
              <p><i class="fas fa-calendar-alt"></i> Jeudi 20 juin 2025</p>
              <p><i class="fas fa-clock"></i> D√©part : 08h00</p>
              <p><i class="fas fa-hourglass-half"></i> Dur√©e : 4h30</p>
              <p><i class="fas fa-map-marked-alt"></i> Distance : 465 km</p>
            </div>

            <div class="info-group">
              <h3><i class="fas fa-leaf"></i> Impact √©cologique</h3>
              <p><i class="fas fa-charging-station"></i> V√©hicule √©lectrique</p>
              <p><i class="fas fa-tree"></i> -75% d'√©missions CO2</p>
              <p><i class="fas fa-users"></i> 2 places disponibles</p>
              <p class="eco-badge">üå± Trajet √©co-responsable</p>
            </div>
          </div>

          <!-- Box prix de r√©servation -->
          <div class="reservation-box">
            <div class="prix-container">
              <span class="prix">15 ‚Ç¨</span>
              <span class="prix-details">par personne</span>
            </div>
            <button
              class="btn-reserver"
              id="btn-participer"
              data-trajet-id="12"
            >
              <i class="fas fa-check-circle"></i> R√©server ce trajet
            </button>
            <p class="places-dispo">
              <i class="fas fa-user-friends"></i> 2 places encore disponibles
            </p>
            <div id="participation-message" class="message-box"></div>
          </div>

          <!-- V√©hicule -->
          <div class="vehicule-info">
            <h2>V√©hicule</h2>
            <p><strong>Marque :</strong> Renault</p>
            <p><strong>Mod√®le :</strong> Zo√©</p>
            <p><strong>√ânergie :</strong> √âlectrique</p>
            <p><strong>Immatriculation :</strong> AB-123-CD</p>
          </div>

          <!-- Section conducteur -->
          <div class="conducteur-info">
            <img
              src="assets/img/photo-chauffeur.jpg"
              alt="Avatar du conducteur"
            />
            <div class="conducteur-details">
              <h3><i class="fas fa-user-circle"></i> Alice Dupont</h3>
              <p class="rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star-half-alt"></i>
                <span>4.7/5</span>
              </p>
              <p class="member-since">
                <i class="fas fa-clock"></i> Membre depuis 2023
              </p>
            </div>
          </div>

          <!-- Pr√©f√©rences conducteur -->
          <div class="preferences">
            <h2>Pr√©f√©rences du chauffeur</h2>
            <ul>
              <li>‚úÖ Non-fumeur</li>
              <li>‚úÖ Animaux accept√©s</li>
              <li>‚úÖ Musique autoris√©e</li>
              <li>üìù Autres : "Pause caf√© bienvenue ‚òï"</li>
            </ul>
          </div>

          <!-- Avis -->
          <section>
            <h2>Avis sur ce chauffeur</h2>
            <div id="avis-liste">
              <p>Chargement des avis en cours...</p>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer>
      <!-- Footer copi√© depuis index.html -->
    </footer>

    <!-- Script pour la r√©servation -->
    <script>
      document
        .getElementById("btn-participer")
        .addEventListener("click", () => {
          const trajetId =
            document.getElementById("btn-participer").dataset.trajetId;
          const msgBox = document.getElementById("participation-message");

          if (
            !confirm(
              "Confirmez-vous vouloir participer √† ce trajet ? Cela co√ªtera 2 cr√©dits."
            )
          ) {
            return;
          }

          // D√©sactiver le bouton pendant la requ√™te
          const btn = document.getElementById("btn-participer");
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Traitement en cours...';

          fetch("../backend/reservations/participer.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: "trajet_id=" + encodeURIComponent(trajetId),
          })
            .then((res) => res.json())
            .then((data) => {
              msgBox.textContent = data.message;
              msgBox.style.color = data.success ? "green" : "red";
              msgBox.classList.add("visible");

              // R√©activer le bouton
              btn.disabled = false;
              btn.innerHTML =
                '<i class="fas fa-check-circle"></i> R√©server ce trajet';

              if (data.success) {
                // Mettre √† jour le nombre de places disponibles
                const placesElement = document.querySelector(".places-dispo");
                const places = parseInt(placesElement.textContent) - 1;
                placesElement.innerHTML = `<i class="fas fa-user-friends"></i> ${places} place${
                  places > 1 ? "s" : ""
                } encore disponible${places > 1 ? "s" : ""}`;
              }
            })
            .catch((error) => {
              msgBox.textContent =
                "Une erreur est survenue. Veuillez r√©essayer.";
              msgBox.style.color = "red";
              msgBox.classList.add("visible");

              // R√©activer le bouton
              btn.disabled = false;
              btn.innerHTML =
                '<i class="fas fa-check-circle"></i> R√©server ce trajet';
            });
        });
    </script>

    <!-- Script pour les avis -->
    <script>
      const params = new URLSearchParams(window.location.search);
      const trajetId = params.get("trajet_id");

      if (!trajetId) {
        document.getElementById("avis-liste").innerHTML =
          "<p>Trajet non sp√©cifi√©</p>";
        throw new Error("trajet_id manquant dans l'URL");
      }

      // √âtape 1 : r√©cup√©rer l'ID du chauffeur depuis le trajet
      fetch("../backend/trajets/get-chauffeur.php?trajet_id=" + trajetId)
        .then((res) => res.json())
        .then((data) => {
          if (!data.success) {
            document.getElementById("avis-liste").innerHTML =
              "<p>Erreur : trajet introuvable</p>";
            return;
          }

          const chauffeurId = data.chauffeur_id;

          // √âtape 2 : charger les avis du chauffeur
          fetch(
            "../backend/avis/lister_valides.php?chauffeur_id=" + chauffeurId
          )
            .then((res) => res.json())
            .then((avisList) => {
              const container = document.getElementById("avis-liste");
              container.innerHTML = "";

              if (avisList.length === 0) {
                container.innerHTML = "<p>Aucun avis pour ce chauffeur.</p>";
                return;
              }

              avisList.forEach((avis) => {
                const div = document.createElement("div");
                div.classList.add("avis-item");
                div.innerHTML = `
                  <p><strong>Note :</strong> ${avis.note} ‚≠ê</p>
                  <p><em>${avis.commentaire}</em></p>
                  <hr />
                `;
                container.appendChild(div);
              });
            });
        });
    </script>
  </body>
</html>
