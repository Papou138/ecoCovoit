<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test d'Int√©gration Frontend-Backend Final</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        background: #f8f9fa;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
      }
      .result {
        padding: 8px;
        margin: 5px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      .summary {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>üîç Test d'Int√©gration Frontend-Backend Final</h1>

    <div class="summary">
      <h2>üìä R√©sum√© des Tests</h2>
      <div id="summary">
        <div class="result warning">En attente des tests...</div>
      </div>
    </div>

    <div class="test-section">
      <h3>üîê Tests d'Authentification</h3>
      <button onclick="testAuthentication()">
        Tester Authentification Compl√®te
      </button>
      <div id="auth-results"></div>
    </div>

    <div class="test-section">
      <h3>üöó Tests de Trajets</h3>
      <button onclick="testTrajets()">Tester Cycle Complet des Trajets</button>
      <div id="trajets-results"></div>
    </div>

    <div class="test-section">
      <h3>üë§ Tests Utilisateur</h3>
      <button onclick="testUser()">Tester Fonctionnalit√©s Utilisateur</button>
      <div id="user-results"></div>
    </div>

    <div class="test-section">
      <h3>üõ†Ô∏è Tests Syst√®me</h3>
      <button onclick="testSystem()">Tester APIs Syst√®me</button>
      <div id="system-results"></div>
    </div>

    <div class="test-section">
      <h3>üß™ Test Complet</h3>
      <button onclick="runFullTest()">Lancer Test Complet de Production</button>
      <div id="full-results"></div>
    </div>

    <script>
      let testStats = {
        total: 0,
        passed: 0,
        failed: 0,
        warnings: 0,
      };

      function updateSummary() {
        const summary = document.getElementById('summary');
        const successRate =
          testStats.total > 0
            ? ((testStats.passed / testStats.total) * 100).toFixed(1)
            : 0;

        let statusClass = 'success';
        let statusText = 'üéâ EXCELLENT';

        if (successRate < 100)
          (statusClass = 'warning'),
            (statusText = '‚ö†Ô∏è AM√âLIORATIONS N√âCESSAIRES');
        if (successRate < 80)
          (statusClass = 'error'), (statusText = '‚ùå CORRECTIONS CRITIQUES');

        summary.innerHTML = `
                <div class="result ${statusClass}">
                    <strong>${statusText}</strong><br>
                    Tests: ${testStats.total} |
                    R√©ussis: ${testStats.passed} |
                    √âchou√©s: ${testStats.failed} |
                    Avertissements: ${testStats.warnings}<br>
                    Taux de r√©ussite: ${successRate}%
                </div>
            `;
      }

      function addResult(containerId, title, type, message, data = null) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = `result ${type}`;

        const icon =
          type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
        div.innerHTML = `
                <strong>${icon} ${title}</strong><br>
                ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;

        container.appendChild(div);

        testStats.total++;
        if (type === 'success') testStats.passed++;
        else if (type === 'error') testStats.failed++;
        else testStats.warnings++;

        updateSummary();
      }

      async function apiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: { 'Content-Type': 'application/json' },
            ...options,
          });

          const data = await response.json();
          return {
            success: response.ok,
            status: response.status,
            data: data,
          };
        } catch (error) {
          return {
            success: false,
            status: 0,
            error: error.message,
          };
        }
      }

      async function testAuthentication() {
        const container = 'auth-results';
        document.getElementById(container).innerHTML = '';

        // Test 1: Inscription
        const registerData = {
          pseudo: `testuser_${Date.now()}`,
          email: `test_${Date.now()}@example.com`,
          password: 'TestPassword123!',
          confirm_password: 'TestPassword123!',
        };

        const registerResult = await apiCall(
          'http://localhost:8000/auth/register.php',
          {
            method: 'POST',
            body: JSON.stringify(registerData),
          }
        );

        if (registerResult.success && registerResult.data.success) {
          addResult(
            container,
            'Inscription utilisateur',
            'success',
            'Nouvel utilisateur cr√©√© avec succ√®s'
          );
        } else {
          addResult(
            container,
            'Inscription utilisateur',
            'error',
            registerResult.data?.message ||
              registerResult.error ||
              'Erreur inconnue'
          );
        }

        // Test 2: Connexion avec utilisateur existant
        const loginData = {
          email: 'chauffeur@test.fr',
          password: 'password123',
        };

        const loginResult = await apiCall(
          'http://localhost:8000/auth/login.php',
          {
            method: 'POST',
            body: JSON.stringify(loginData),
          }
        );

        if (loginResult.success) {
          addResult(
            container,
            'Connexion utilisateur',
            'success',
            'Connexion fonctionnelle'
          );
        } else {
          addResult(
            container,
            'Connexion utilisateur',
            'warning',
            loginResult.data?.message || 'Identifiants de test invalides'
          );
        }

        // Test 3: D√©connexion
        const logoutResult = await apiCall(
          'http://localhost:8000/auth/logout.php',
          {
            method: 'POST',
          }
        );

        if (logoutResult.success) {
          addResult(
            container,
            'D√©connexion',
            'success',
            'D√©connexion fonctionnelle'
          );
        } else {
          addResult(
            container,
            'D√©connexion',
            'warning',
            'Probl√®me de d√©connexion'
          );
        }
      }

      async function testTrajets() {
        const container = 'trajets-results';
        document.getElementById(container).innerHTML = '';

        // Test 1: Recherche de trajets
        const searchResult = await apiCall(
          'http://localhost:8000/trajets/rechercher.php?depart=Paris&arrivee=Lyon'
        );

        if (searchResult.success) {
          addResult(
            container,
            'Recherche trajets',
            'success',
            'API de recherche fonctionnelle'
          );
        } else {
          addResult(
            container,
            'Recherche trajets',
            'error',
            'Erreur dans la recherche'
          );
        }

        // Test 2: D√©tail d'un trajet
        const detailResult = await apiCall(
          'http://localhost:8000/trajets/detail.php?id=1'
        );

        if (detailResult.status === 200) {
          addResult(
            container,
            'D√©tail trajet',
            'success',
            'API de d√©tail accessible'
          );
        } else {
          addResult(
            container,
            'D√©tail trajet',
            'warning',
            `HTTP ${detailResult.status}`
          );
        }

        // Test 3: Cr√©ation de trajet (sans authentification - attendu d'√©chouer)
        const createData = {
          depart: 'Marseille',
          arrivee: 'Nice',
          date_depart: '2025-07-20',
          heure_depart: '14:00',
          places_disponibles: 3,
          prix_par_place: 15,
        };

        const createResult = await apiCall(
          'http://localhost:8000/trajets/create.php',
          {
            method: 'POST',
            body: JSON.stringify(createData),
          }
        );

        if (createResult.status === 401) {
          addResult(
            container,
            'S√©curit√© cr√©ation trajet',
            'success',
            'Authentification requise (s√©curit√© OK)'
          );
        } else if (createResult.success) {
          addResult(
            container,
            'Cr√©ation trajet',
            'warning',
            'Cr√©ation possible sans auth (s√©curit√© √† v√©rifier)'
          );
        } else {
          addResult(container, 'API cr√©ation trajet', 'warning', 'Erreur API');
        }
      }

      async function testUser() {
        const container = 'user-results';
        document.getElementById(container).innerHTML = '';

        // Test APIs utilisateur (attendues d'√©chouer sans auth)
        const userAPIs = [
          {
            url: 'http://localhost:8000/users/profile.php',
            name: 'Profil utilisateur',
          },
          {
            url: 'http://localhost:8000/users/vehicles.php',
            name: 'Gestion v√©hicules',
          },
          {
            url: 'http://localhost:8000/users/preferences.php',
            name: 'Pr√©f√©rences',
          },
        ];

        for (const api of userAPIs) {
          const result = await apiCall(api.url);

          if (result.status === 401) {
            addResult(
              container,
              `S√©curit√© ${api.name}`,
              'success',
              'Authentification requise (s√©curit√© OK)'
            );
          } else if (result.success) {
            addResult(
              container,
              api.name,
              'warning',
              'Accessible sans auth (s√©curit√© √† v√©rifier)'
            );
          } else {
            addResult(container, api.name, 'warning', `HTTP ${result.status}`);
          }
        }
      }

      async function testSystem() {
        const container = 'system-results';
        document.getElementById(container).innerHTML = '';

        // Test APIs syst√®me
        const configResult = await apiCall(
          'http://localhost:8000/system/config.php?action=config'
        );

        if (configResult.success && configResult.data.success) {
          addResult(
            container,
            'Configuration syst√®me',
            'success',
            'API de configuration op√©rationnelle'
          );
        } else {
          addResult(
            container,
            'Configuration syst√®me',
            'error',
            'Erreur API configuration'
          );
        }

        const monitoringResult = await apiCall(
          'http://localhost:8000/system/monitoring.php?action=health'
        );

        if (monitoringResult.success && monitoringResult.data.success) {
          addResult(
            container,
            'Monitoring syst√®me',
            'success',
            'API de monitoring op√©rationnelle'
          );
        } else {
          addResult(
            container,
            'Monitoring syst√®me',
            'error',
            'Erreur API monitoring'
          );
        }

        // Test APIs admin (attendues d'√©chouer sans auth admin)
        const adminResult = await apiCall(
          'http://localhost:8000/admin/dashboard.php'
        );

        if (adminResult.status === 401) {
          addResult(
            container,
            'S√©curit√© admin',
            'success',
            'Authentification admin requise (s√©curit√© OK)'
          );
        } else {
          addResult(
            container,
            'S√©curit√© admin',
            'error',
            'Admin accessible sans auth (CRITIQUE)'
          );
        }
      }

      async function runFullTest() {
        const container = 'full-results';
        document.getElementById(container).innerHTML = '';

        // R√©initialiser les stats
        testStats = { total: 0, passed: 0, failed: 0, warnings: 0 };
        updateSummary();

        addResult(
          container,
          'Test complet d√©marr√©',
          'success',
          "Lancement de tous les tests d'int√©gration..."
        );

        // Lancer tous les tests en s√©quence
        await testAuthentication();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testTrajets();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testUser();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testSystem();

        // R√©sum√© final
        const successRate = (
          (testStats.passed / testStats.total) *
          100
        ).toFixed(1);

        if (successRate >= 90) {
          addResult(
            container,
            'Test complet termin√©',
            'success',
            `üéâ EXCELLENT - Taux de r√©ussite: ${successRate}% - Pr√™t pour production!`
          );
        } else if (successRate >= 75) {
          addResult(
            container,
            'Test complet termin√©',
            'warning',
            `‚ö†Ô∏è BON - Taux de r√©ussite: ${successRate}% - Quelques ajustements n√©cessaires`
          );
        } else {
          addResult(
            container,
            'Test complet termin√©',
            'error',
            `‚ùå CRITIQUE - Taux de r√©ussite: ${successRate}% - Corrections importantes n√©cessaires`
          );
        }
      }

      // Auto-d√©marrage des tests
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
          testSystem(); // Commencer par les tests syst√®me
        }, 1000);
      });
    </script>
  </body>
</html>
