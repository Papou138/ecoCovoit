<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test d'Int√©gration Frontend-Backend</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîç Test d'Int√©gration Frontend-Backend ecoCovoit</h1>

    <div class="test-section">
      <h2>üìä √âtat des Serveurs</h2>
      <div id="server-status"></div>
      <button onclick="checkServers()">V√©rifier les serveurs</button>
    </div>

    <div class="test-section">
      <h2>üîê Tests d'Authentification</h2>
      <div id="auth-results"></div>
      <button onclick="testAuth()">Tester l'authentification</button>
      <button onclick="testRegister()">Tester l'inscription</button>
      <button onclick="testLogout()">Tester la d√©connexion</button>
    </div>

    <div class="test-section">
      <h2>üöó Tests de Trajets</h2>
      <div id="trajets-results"></div>
      <button onclick="testSearchTrajets()">Rechercher trajets</button>
      <button onclick="testCreateTrajet()">Cr√©er trajet</button>
      <button onclick="testTrajetDetail()">D√©tail trajet</button>
    </div>

    <div class="test-section">
      <h2>üë§ Tests Utilisateur</h2>
      <div id="user-results"></div>
      <button onclick="testUserProfile()">Profil utilisateur</button>
      <button onclick="testUserVehicles()">Gestion v√©hicules</button>
      <button onclick="testUserPreferences()">Pr√©f√©rences</button>
    </div>

    <div class="test-section">
      <h2>üìã Tests R√©servations</h2>
      <div id="reservations-results"></div>
      <button onclick="testReservations()">Mes r√©servations</button>
      <button onclick="testParticipation()">Participation trajet</button>
    </div>

    <div class="test-section">
      <h2>üõ†Ô∏è Tests Administration</h2>
      <div id="admin-results"></div>
      <button onclick="testAdminDashboard()">Dashboard admin</button>
      <button onclick="testAdminUsers()">Gestion utilisateurs</button>
    </div>

    <div class="test-section">
      <h2>üìà R√©sum√© des Tests</h2>
      <div id="summary"></div>
      <button onclick="runAllTests()">Lancer tous les tests</button>
    </div>

    <script>
      let testResults = {
        passed: 0,
        failed: 0,
        total: 0,
      };

      // Fonction utilitaire pour afficher les r√©sultats
      function displayResult(
        containerId,
        title,
        success,
        message,
        data = null
      ) {
        const container = document.getElementById(containerId);
        const resultClass = success ? 'success' : 'error';
        const icon = success ? '‚úÖ' : '‚ùå';

        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${resultClass}`;
        resultDiv.innerHTML = `
                <strong>${icon} ${title}</strong><br>
                ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;

        container.appendChild(resultDiv);

        testResults.total++;
        if (success) testResults.passed++;
        else testResults.failed++;

        updateSummary();
      }

      function updateSummary() {
        const summary = document.getElementById('summary');
        const successRate =
          testResults.total > 0
            ? ((testResults.passed / testResults.total) * 100).toFixed(1)
            : 0;

        summary.innerHTML = `
                <div class="test-result info">
                    <strong>üìä R√©sultats des Tests</strong><br>
                    Total: ${testResults.total} |
                    R√©ussis: ${testResults.passed} |
                    √âchou√©s: ${testResults.failed} |
                    Taux de r√©ussite: ${successRate}%
                </div>
            `;
      }

      // Test des serveurs
      async function checkServers() {
        const statusDiv = document.getElementById('server-status');
        statusDiv.innerHTML =
          '<div class="test-result info">üîÑ V√©rification des serveurs...</div>';

        // Test serveur frontend
        try {
          const frontendResponse = await fetch(
            'http://localhost:8080/index.html'
          );
          displayResult(
            'server-status',
            'Serveur Frontend (port 8080)',
            frontendResponse.ok,
            `HTTP ${frontendResponse.status}`
          );
        } catch (error) {
          displayResult(
            'server-status',
            'Serveur Frontend (port 8080)',
            false,
            `Erreur: ${error.message}`
          );
        }

        // Test serveur backend
        try {
          const backendResponse = await fetch(
            'http://localhost:8000/index.php'
          );
          displayResult(
            'server-status',
            'Serveur Backend (port 8000)',
            backendResponse.ok,
            `HTTP ${backendResponse.status}`
          );
        } catch (error) {
          displayResult(
            'server-status',
            'Serveur Backend (port 8000)',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Tests d'authentification
      async function testAuth() {
        try {
          const response = await fetch('http://localhost:8000/auth/login.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'chauffeur@test.fr',
              password: 'password123',
            }),
          });

          const data = await response.json();
          displayResult(
            'auth-results',
            'Connexion utilisateur',
            response.ok && data.success,
            data.message || `HTTP ${response.status}`,
            response.ok ? data : null
          );
        } catch (error) {
          displayResult(
            'auth-results',
            'Connexion utilisateur',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testRegister() {
        try {
          const timestamp = Date.now();
          const response = await fetch(
            'http://localhost:8000/auth/register.php',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                pseudo: `testuser_${timestamp}`,
                email: `test_${timestamp}@example.com`,
                password: 'Password123!',
                confirm_password: 'Password123!',
              }),
            }
          );

          const data = await response.json();
          displayResult(
            'auth-results',
            'Inscription utilisateur',
            response.ok && data.success,
            data.message || `HTTP ${response.status}`,
            response.ok ? data : null
          );
        } catch (error) {
          displayResult(
            'auth-results',
            'Inscription utilisateur',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testLogout() {
        try {
          const response = await fetch(
            'http://localhost:8000/auth/logout.php',
            {
              method: 'POST',
            }
          );

          const data = await response.json();
          displayResult(
            'auth-results',
            'D√©connexion',
            response.ok,
            data.message || `HTTP ${response.status}`,
            response.ok ? data : null
          );
        } catch (error) {
          displayResult(
            'auth-results',
            'D√©connexion',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Tests de trajets
      async function testSearchTrajets() {
        try {
          const response = await fetch(
            'http://localhost:8000/trajets/rechercher.php?depart=Paris&arrivee=Lyon'
          );
          const data = await response.json();

          displayResult(
            'trajets-results',
            'Recherche trajets',
            response.ok,
            `${response.status} - ${data.message || 'R√©ponse re√ßue'}`,
            data
          );
        } catch (error) {
          displayResult(
            'trajets-results',
            'Recherche trajets',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testCreateTrajet() {
        try {
          const response = await fetch(
            'http://localhost:8000/trajets/create.php',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                depart: 'Marseille',
                arrivee: 'Nice',
                date_depart: '2025-07-20',
                heure_depart: '14:00',
                places_disponibles: 3,
                prix_par_place: 15,
              }),
            }
          );

          const data = await response.json();
          displayResult(
            'trajets-results',
            'Cr√©ation trajet',
            response.ok,
            `${response.status} - ${data.message || 'Trajet cr√©√©'}`,
            data
          );
        } catch (error) {
          displayResult(
            'trajets-results',
            'Cr√©ation trajet',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testTrajetDetail() {
        try {
          const response = await fetch(
            'http://localhost:8000/trajets/detail.php?id=1'
          );
          const data = await response.json();

          displayResult(
            'trajets-results',
            'D√©tail trajet',
            response.ok,
            `${response.status} - ${data.message || 'D√©tails r√©cup√©r√©s'}`,
            data
          );
        } catch (error) {
          displayResult(
            'trajets-results',
            'D√©tail trajet',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Tests utilisateur (n√©cessitent authentification)
      async function testUserProfile() {
        try {
          const response = await fetch(
            'http://localhost:8000/users/profile.php'
          );
          const data = await response.json();

          displayResult(
            'user-results',
            'Profil utilisateur',
            response.ok,
            `${response.status} - ${data.message || 'Profil r√©cup√©r√©'}`,
            data
          );
        } catch (error) {
          displayResult(
            'user-results',
            'Profil utilisateur',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testUserVehicles() {
        try {
          const response = await fetch(
            'http://localhost:8000/users/vehicles.php'
          );
          const data = await response.json();

          displayResult(
            'user-results',
            'Gestion v√©hicules',
            response.ok,
            `${response.status} - ${data.message || 'V√©hicules r√©cup√©r√©s'}`,
            data
          );
        } catch (error) {
          displayResult(
            'user-results',
            'Gestion v√©hicules',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testUserPreferences() {
        try {
          const response = await fetch(
            'http://localhost:8000/users/preferences.php'
          );
          const data = await response.json();

          displayResult(
            'user-results',
            'Pr√©f√©rences utilisateur',
            response.ok,
            `${response.status} - ${data.message || 'Pr√©f√©rences r√©cup√©r√©es'}`,
            data
          );
        } catch (error) {
          displayResult(
            'user-results',
            'Pr√©f√©rences utilisateur',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Tests r√©servations
      async function testReservations() {
        try {
          const response = await fetch(
            'http://localhost:8000/reservations/mes-reservations.php'
          );
          const data = await response.json();

          displayResult(
            'reservations-results',
            'Mes r√©servations',
            response.ok,
            `${response.status} - ${data.message || 'R√©servations r√©cup√©r√©es'}`,
            data
          );
        } catch (error) {
          displayResult(
            'reservations-results',
            'Mes r√©servations',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testParticipation() {
        try {
          const response = await fetch(
            'http://localhost:8000/trajets/participate.php',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                trajet_id: 1,
                places_demandees: 1,
              }),
            }
          );

          const data = await response.json();
          displayResult(
            'reservations-results',
            'Participation trajet',
            response.ok,
            `${response.status} - ${
              data.message || 'Participation enregistr√©e'
            }`,
            data
          );
        } catch (error) {
          displayResult(
            'reservations-results',
            'Participation trajet',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Tests administration
      async function testAdminDashboard() {
        try {
          const response = await fetch(
            'http://localhost:8000/admin/dashboard.php'
          );
          const data = await response.json();

          displayResult(
            'admin-results',
            'Dashboard admin',
            response.ok,
            `${response.status} - ${data.message || 'Dashboard charg√©'}`,
            data
          );
        } catch (error) {
          displayResult(
            'admin-results',
            'Dashboard admin',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      async function testAdminUsers() {
        try {
          const response = await fetch('http://localhost:8000/admin/users.php');
          const data = await response.json();

          displayResult(
            'admin-results',
            'Gestion utilisateurs',
            response.ok,
            `${response.status} - ${data.message || 'Utilisateurs charg√©s'}`,
            data
          );
        } catch (error) {
          displayResult(
            'admin-results',
            'Gestion utilisateurs',
            false,
            `Erreur: ${error.message}`
          );
        }
      }

      // Lancer tous les tests
      async function runAllTests() {
        // R√©initialiser les r√©sultats
        testResults = { passed: 0, failed: 0, total: 0 };

        // Vider les conteneurs de r√©sultats
        [
          'server-status',
          'auth-results',
          'trajets-results',
          'user-results',
          'reservations-results',
          'admin-results',
        ].forEach((id) => {
          document.getElementById(id).innerHTML = '';
        });

        // Lancer tous les tests avec des d√©lais pour √©viter la surcharge
        await checkServers();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testAuth();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testRegister();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testSearchTrajets();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testCreateTrajet();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testTrajetDetail();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testUserProfile();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testReservations();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testAdminDashboard();
      }

      // Lancer la v√©rification des serveurs au chargement
      document.addEventListener('DOMContentLoaded', function () {
        checkServers();
      });
    </script>
  </body>
</html>
