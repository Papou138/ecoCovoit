<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposer un trajet – ecoCovoit</title>
    <link rel="stylesheet" href="assets/css/_commun.css">
    <link rel="stylesheet" href="assets/css/_header.css">
    <link rel="stylesheet" href="assets/css/_footer.css">
    <link rel="stylesheet" href="assets/css/add-voyage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img
                    src="assets/img/logo-ecoRide.png"
                    alt="Logo ecoCovoit"
                    class="logo"
                    width="50"
                    height="50"
                    loading="lazy"
                />
                <h1 class="app-title">ecoCovoit</h1>
            </div>

            <button
                id="menu-toggle"
                class="menu-toggle"
                aria-label="Ouvrir le menu Principal"
                aria-expanded="false"
                aria-controls="main-nav"
                type="button"
            >
                <span class="hamburger-line" aria-hidden="true"></span>
                <span class="hamburger-line" aria-hidden="true"></span>
                <span class="hamburger-line" aria-hidden="true"></span>
            </button>

            <nav id="main-nav" class="main-nav" role="navigation" aria-label="Menu principal de navigation">
                <ul class="nav-list">
                    <li>
                        <a href="index.html" class="nav-link"
                            ><i class="fas fa-home"></i> Accueil</a
                        >
                    </li>
                    <li>
                        <a href="rechercher-covoiturage.html" class="nav-link"
                            ><i class="fas fa-search"></i> Rechercher</a
                        >
                    </li>
                    <li>
                        <a href="add-voyage.html" class="nav-link active"
                            ><i class="fas fa-plus-circle"></i> Publier</a
                        >
                    </li>
                    <li>
                        <a href="mes-reservations.html" class="nav-link"
                            ><i class="fas fa-calendar-check"></i> Mes réservations</a
                        >
                    </li>
                    <li>
                        <a href="historique.html" class="nav-link"
                            ><i class="fas fa-history"></i> Historique</a
                        >
                    </li>
                    <li>
                        <a href="user-profile.html" class="nav-link"
                            ><i class="fas fa-user"></i> Mon profil</a
                        >
                    </li>
                    <li>
                        <a href="add-vehicule.html" class="nav-link"
                            ><i class="fas fa-car"></i> Mes véhicules</a
                        >
                    </li>
                    <li>
                        <a href="add-preferences.html" class="nav-link"
                            ><i class="fas fa-cog"></i> Préférences</a
                        >
                    </li>
                    <li>
                        <a href="#" class="nav-link logout-btn" onclick="logout()"
                            ><i class="fas fa-sign-out-alt"></i> Déconnexion</a
                        >
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- SECTION PRESENTATION -->
        <section class="presentation-section">
            <div class="presentation-content">
                <div class="text-content">
                    <h2>Proposer un trajet</h2>
                    <p>
                        <i class="fas fa-route"></i> Partagez votre voyage et réduisez votre empreinte carbone
                    </p>
                    <p>
                        <i class="fas fa-leaf"></i> Éco-responsable<br />
                        <i class="fas fa-users"></i> Convivial et solidaire<br />
                        <i class="fas fa-euro-sign"></i> Économique<br />
                        <i class="fas fa-heart"></i> Contribuez à un monde plus vert
                    </p>
                </div>
                <div class="image-container">
                    <div class="trip-hero-icon">
                        <i class="fas fa-car-side"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION FORMULAIRE -->
        <section class="trip-form-section">
            <div class="container">
                <h2>Informations du trajet</h2>
                <div class="auth-container">
                    <div class="auth-card trip-form">

                <form id="trip-form" class="auth-form">
                    <!-- Étape 1: Itinéraire -->
                    <div class="form-section" data-step="1">
                        <h3><i class="fas fa-map-marked-alt"></i> Itinéraire</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="ville_depart">
                                    <i class="fas fa-play"></i>
                                    Ville de départ
                                </label>
                                <input type="text" id="ville_depart" name="ville_depart" required
                                       placeholder="Ex: Lyon">
                                <div class="suggestions" id="depart-suggestions"></div>
                                <div class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="ville_arrivee">
                                    <i class="fas fa-flag-checkered"></i>
                                    Ville d'arrivée
                                </label>
                                <input type="text" id="ville_arrivee" name="ville_arrivee" required
                                       placeholder="Ex: Paris">
                                <div class="suggestions" id="arrivee-suggestions"></div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="etapes">
                                <i class="fas fa-map-pin"></i>
                                Étapes intermédiaires (optionnel)
                            </label>
                            <input type="text" id="etapes" name="etapes"
                                   placeholder="Ex: Mâcon, Beaune (séparées par des virgules)">
                            <small class="form-hint">Mentionnez les villes où vous pouvez prendre ou déposer des passagers</small>
                        </div>
                    </div>

                    <!-- Étape 2: Date et heure -->
                    <div class="form-section" data-step="2">
                        <h3><i class="fas fa-clock"></i> Date et heure</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="date_depart">
                                    <i class="fas fa-calendar"></i>
                                    Date du trajet
                                </label>
                                <input type="date" id="date_depart" name="date_depart" required>
                                <div class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="heure_depart">
                                    <i class="fas fa-clock"></i>
                                    Heure de départ
                                </label>
                                <input type="time" id="heure_depart" name="heure_depart" required>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="duree_estimee">
                                <i class="fas fa-hourglass-half"></i>
                                Durée estimée
                            </label>
                            <select id="duree_estimee" name="duree_estimee" required>
                                <option value="">Sélectionner la durée</option>
                                <option value="30min">30 minutes</option>
                                <option value="1h">1 heure</option>
                                <option value="1h30">1h30</option>
                                <option value="2h">2 heures</option>
                                <option value="2h30">2h30</option>
                                <option value="3h">3 heures</option>
                                <option value="4h">4 heures</option>
                                <option value="5h">5 heures et plus</option>
                            </select>
                            <div class="error-message"></div>
                        </div>
                    </div>

                    <!-- Étape 3: Véhicule et places -->
                    <div class="form-section" data-step="3">
                        <h3><i class="fas fa-car"></i> Véhicule et places</h3>

                        <div class="form-group">
                            <label for="vehicule_id">
                                <i class="fas fa-car-side"></i>
                                Véhicule utilisé
                            </label>
                            <select id="vehicule_id" name="vehicule_id" required>
                                <option value="">Chargement...</option>
                            </select>
                            <div class="no-vehicle-message hidden">
                                <p><i class="fas fa-info-circle"></i> Vous devez d'abord ajouter un véhicule</p>
                                <a href="add-vehicule.html" class="btn-secondary">
                                    <i class="fas fa-plus"></i> Ajouter un véhicule
                                </a>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="places_disponibles">
                                    <i class="fas fa-users"></i>
                                    Places disponibles
                                </label>
                                <select id="places_disponibles" name="places_disponibles" required>
                                    <option value="">Sélectionner</option>
                                    <option value="1">1 place</option>
                                    <option value="2">2 places</option>
                                    <option value="3">3 places</option>
                                    <option value="4">4 places</option>
                                    <option value="5">5 places</option>
                                    <option value="6">6 places</option>
                                    <option value="7">7 places</option>
                                </select>
                                <div class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="prix">
                                    <i class="fas fa-euro-sign"></i>
                                    Prix par passager (€)
                                </label>
                                <input type="number" id="prix" name="prix" required
                                       min="0" max="100" step="0.50" placeholder="15.00">
                                <small class="form-hint">Prix recommandé: <span id="prix-recommande">-</span>€</small>
                                <div class="error-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Étape 4: Préférences et options -->
                    <div class="form-section" data-step="4">
                        <h3><i class="fas fa-cog"></i> Préférences du voyage</h3>

                        <div class="preferences-grid">
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="musique" name="preferences[]" value="musique">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-music"></i>
                                    Musique autorisée
                                </label>
                            </div>
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="fumeur" name="preferences[]" value="fumeur">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-smoking"></i>
                                    Fumeur autorisé
                                </label>
                            </div>
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="animaux" name="preferences[]" value="animaux">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-paw"></i>
                                    Animaux acceptés
                                </label>
                            </div>
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="bagages" name="preferences[]" value="bagages">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-suitcase"></i>
                                    Gros bagages acceptés
                                </label>
                            </div>
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="climatisation" name="preferences[]" value="climatisation">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-snowflake"></i>
                                    Climatisation
                                </label>
                            </div>
                            <div class="preference-item">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="detours" name="preferences[]" value="detours">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-map-signs"></i>
                                    Détours possibles
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="commentaire">
                                <i class="fas fa-comment"></i>
                                Commentaire (optionnel)
                            </label>
                            <textarea id="commentaire" name="commentaire" rows="4"
                                      placeholder="Informations supplémentaires pour les passagers..."></textarea>
                        </div>
                    </div>

                    <!-- Récapitulatif -->
                    <div class="trip-summary">
                        <h3><i class="fas fa-clipboard-list"></i> Récapitulatif</h3>
                        <div id="trip-recap" class="recap-content">
                            <!-- Le contenu sera généré dynamiquement -->
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancel-btn" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            <span id="submit-text">Publier le trajet</span>
                        </button>
                    </div>

                    <div id="form-feedback" class="form-feedback"></div>
                </form>
            </div>
        </div>
    </section>
</main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h3><i class="fas fa-car-side"></i> ecoCovoit</h3>
          <p>
            <i class="fas fa-seedling"></i> La plateforme de covoiturage
            écoresponsable
          </p>
          <p>
            <i class="fas fa-handshake"></i> Réduisons ensemble notre empreinte
            carbone
          </p>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-address-book"></i> Contact</h3>
          <p>
            <i class="fas fa-envelope"></i
            ><a href="mailto:contact@ecoride.fr"> contact@ecoride.fr</a>
          </p>
          <p><i class="fas fa-phone"></i> +33 1 23 45 67 89</p>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-info-circle"></i> Informations</h3>
          <ul>
            <li>
              <i class="fas fa-gavel"></i
              ><a href="mentions.html"> Mentions légales</a>
            </li>
            <li>
              <i class="fas fa-envelope"></i
              ><a href="contact.html"> Nous contacter</a>
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-share-alt"></i> Suivez-nous</h3>
          <div class="social-links">
            <a href="#" class="social-link" title="Facebook"
              ><i class="fab fa-facebook-f"></i
            ></a>
            <a href="#" class="social-link" title="Twitter"
              ><i class="fab fa-twitter"></i
            ></a>
            <a href="#" class="social-link" title="LinkedIn"
              ><i class="fab fa-linkedin-in"></i
            ></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 EcoRide. Tous droits réservés.</p>
        <p>
          <i class="fas fa-leaf"></i> Pour une mobilité plus verte
          <i class="fas fa-leaf text-green"></i>
        </p>
      </div>
    </footer>

    <script src="assets/js/menu.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('trip-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submit-text');
            const feedback = document.getElementById('form-feedback');
            const cancelBtn = document.getElementById('cancel-btn');

            // Initialisation
            init();

            function init() {
                loadUserVehicles();
                setupEventListeners();
                setMinDate();
                setupCityAutocomplete();
                updateRecap();
            }

            // Définir la date minimum à aujourd'hui
            function setMinDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date_depart').min = today;
            }

            // Charger les véhicules de l'utilisateur
            async function loadUserVehicles() {
                try {
                    const response = await fetch('../backend/vehicules/lister.php');
                    const data = await response.json();

                    const vehiculeSelect = document.getElementById('vehicule_id');
                    const noVehicleMessage = document.querySelector('.no-vehicle-message');

                    if (data.success && data.vehicules && data.vehicules.length > 0) {
                        vehiculeSelect.innerHTML = '<option value="">Sélectionner un véhicule</option>';
                        data.vehicules.forEach(vehicle => {
                            const option = document.createElement('option');
                            option.value = vehicle.id;
                            option.textContent = `${vehicle.marque} ${vehicle.modele} (${vehicle.couleur})`;
                            option.dataset.places = vehicle.places;
                            vehiculeSelect.appendChild(option);
                        });

                        // Mettre à jour les places disponibles quand on change de véhicule
                        vehiculeSelect.addEventListener('change', updateAvailableSeats);

                    } else {
                        vehiculeSelect.style.display = 'none';
                        noVehicleMessage.style.display = 'block';
                    }

                } catch (error) {
                    console.error('Erreur lors du chargement des véhicules:', error);
                    showFeedback('Erreur lors du chargement des véhicules', 'error');
                }
            }

            // Mettre à jour les places disponibles selon le véhicule
            function updateAvailableSeats() {
                const vehiculeSelect = document.getElementById('vehicule_id');
                const placesSelect = document.getElementById('places_disponibles');

                if (vehiculeSelect.value) {
                    const selectedOption = vehiculeSelect.options[vehiculeSelect.selectedIndex];
                    const maxPlaces = parseInt(selectedOption.dataset.places) - 1; // -1 pour le conducteur

                    placesSelect.innerHTML = '<option value="">Sélectionner</option>';
                    for (let i = 1; i <= maxPlaces; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i === 1 ? '1 place' : `${i} places`;
                        placesSelect.appendChild(option);
                    }

                    // Calculer le prix recommandé
                    calculateRecommendedPrice();
                }
            }

            // Calculer le prix recommandé basé sur la distance
            function calculateRecommendedPrice() {
                const depart = document.getElementById('ville_depart').value;
                const arrivee = document.getElementById('ville_arrivee').value;

                if (depart && arrivee) {
                    // Simulation du calcul (à remplacer par une vraie API de calcul de distance)
                    const distance = Math.random() * 500 + 50; // Distance simulée entre 50 et 550 km
                    const prixRecommande = Math.round((distance * 0.15) * 100) / 100; // 0.15€/km
                    document.getElementById('prix-recommande').textContent = prixRecommande.toFixed(2);
                }
            }

            // Configuration de l'autocomplétion des villes
            function setupCityAutocomplete() {
                const cities = [
                    'Paris', 'Lyon', 'Marseille', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg',
                    'Montpellier', 'Bordeaux', 'Lille', 'Rennes', 'Reims', 'Le Havre',
                    'Saint-Étienne', 'Toulon', 'Grenoble', 'Dijon', 'Angers', 'Nîmes', 'Villeurbanne'
                ];

                setupAutocomplete('ville_depart', cities);
                setupAutocomplete('ville_arrivee', cities);
            }

            function setupAutocomplete(inputId, cities) {
                const input = document.getElementById(inputId);
                const suggestions = document.getElementById(inputId.replace('ville_', '') + '-suggestions');

                input.addEventListener('input', function() {
                    const value = this.value.toLowerCase();
                    suggestions.innerHTML = '';

                    if (value.length > 1) {
                        const filtered = cities.filter(city =>
                            city.toLowerCase().includes(value)
                        ).slice(0, 5);

                        filtered.forEach(city => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = city;
                            div.addEventListener('click', () => {
                                input.value = city;
                                suggestions.innerHTML = '';
                                calculateRecommendedPrice();
                                updateRecap();
                            });
                            suggestions.appendChild(div);
                        });
                    }
                });

                // Fermer les suggestions en cliquant ailleurs
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.innerHTML = '';
                    }
                });
            }

            // Gestion des événements
            function setupEventListeners() {
                // Soumission du formulaire
                form.addEventListener('submit', handleSubmit);

                // Annulation
                cancelBtn.addEventListener('click', () => {
                    if (confirm('Êtes-vous sûr de vouloir annuler ? Les informations saisies seront perdues.')) {
                        window.location.href = 'index.html';
                    }
                });

                // Mise à jour du récapitulatif en temps réel
                form.addEventListener('input', updateRecap);
                form.addEventListener('change', updateRecap);

                // Déconnexion
                document.querySelector('.logout-btn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                        try {
                            await fetch('../backend/auth/logout.php');
                            window.location.href = 'login.html';
                        } catch (error) {
                            console.error('Erreur lors de la déconnexion:', error);
                            window.location.href = 'login.html';
                        }
                    }
                });
            }

            // Mettre à jour le récapitulatif
            function updateRecap() {
                const recap = document.getElementById('trip-recap');
                const depart = document.getElementById('ville_depart').value;
                const arrivee = document.getElementById('ville_arrivee').value;
                const date = document.getElementById('date_depart').value;
                const heure = document.getElementById('heure_depart').value;
                const places = document.getElementById('places_disponibles').value;
                const prix = document.getElementById('prix').value;

                let html = '<div class="recap-grid">';

                if (depart && arrivee) {
                    html += `
                        <div class="recap-item">
                            <i class="fas fa-route"></i>
                            <span><strong>Trajet:</strong> ${depart} → ${arrivee}</span>
                        </div>
                    `;
                }

                if (date && heure) {
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    });
                    html += `
                        <div class="recap-item">
                            <i class="fas fa-calendar-clock"></i>
                            <span><strong>Date:</strong> ${formattedDate} à ${heure}</span>
                        </div>
                    `;
                }

                if (places) {
                    html += `
                        <div class="recap-item">
                            <i class="fas fa-users"></i>
                            <span><strong>Places:</strong> ${places} passager${places > 1 ? 's' : ''}</span>
                        </div>
                    `;
                }

                if (prix) {
                    html += `
                        <div class="recap-item">
                            <i class="fas fa-euro-sign"></i>
                            <span><strong>Prix:</strong> ${prix}€ par personne</span>
                        </div>
                    `;
                }

                html += '</div>';
                recap.innerHTML = html || '<p class="empty-recap">Complétez le formulaire pour voir le récapitulatif</p>';
            }

            // Soumission du formulaire
            async function handleSubmit(e) {
                e.preventDefault();

                if (!validateForm()) return;

                const formData = new FormData(form);

                // Animation de chargement
                const originalText = submitText.textContent;
                submitText.textContent = 'Publication...';
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + submitText.textContent;
                submitBtn.disabled = true;

                try {
                    const response = await fetch('../backend/trajets/ajouter.php', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showFeedback('Trajet publié avec succès !', 'success');
                        setTimeout(() => {
                            window.location.href = 'user-profile.html';
                        }, 2000);
                    } else {
                        showFeedback(data.message || 'Erreur lors de la publication', 'error');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    showFeedback('Erreur de connexion', 'error');
                } finally {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ' + originalText;
                    submitText.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            // Validation du formulaire
            function validateForm() {
                let isValid = true;
                const requiredFields = [
                    'ville_depart', 'ville_arrivee', 'date_depart', 'heure_depart',
                    'duree_estimee', 'vehicule_id', 'places_disponibles', 'prix'
                ];

                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (!field.value.trim()) {
                        showFieldError(field, 'Ce champ est obligatoire');
                        isValid = false;
                    } else {
                        clearFieldError(field);
                    }
                });

                // Validations spécifiques
                const dateDepart = document.getElementById('date_depart');
                if (dateDepart.value) {
                    const selectedDate = new Date(dateDepart.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        showFieldError(dateDepart, 'La date ne peut pas être dans le passé');
                        isValid = false;
                    }
                }

                const prix = document.getElementById('prix');
                if (prix.value && (parseFloat(prix.value) < 0 || parseFloat(prix.value) > 100)) {
                    showFieldError(prix, 'Le prix doit être entre 0 et 100€');
                    isValid = false;
                }

                return isValid;
            }

            function showFieldError(field, message) {
                field.classList.add('error');
                const errorDiv = field.parentNode.querySelector('.error-message');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }

            function clearFieldError(field) {
                field.classList.remove('error');
                const errorDiv = field.parentNode.querySelector('.error-message');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }

            function showFeedback(message, type) {
                feedback.textContent = message;
                feedback.className = `form-feedback ${type}`;
                feedback.style.display = 'block';

                if (type === 'success') {
                    feedback.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                } else {
                    feedback.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
                }
            }
        });
    </script>
</body>
</html>
