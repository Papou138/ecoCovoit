<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Gestion des incidents ecoCovoit - Interface employé pour traiter les signalements et incidents de la plateforme de covoiturage."
    />
    <meta
      name="keywords"
      content="gestion incidents, signalements, employé, support, covoiturage, résolution"
    />
    <meta name="author" content="ecoCovoit" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Gestion des Incidents - Employé ecoCovoit</title>
    <link rel="stylesheet" href="assets/css/_commun.css" />
    <link rel="stylesheet" href="assets/css/_header.css" />
    <link rel="stylesheet" href="assets/css/_footer.css" />
    <link rel="stylesheet" href="assets/css/employe-incidents.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>
  <body>
    <!-- HEADER -->
    <header>
      <div class="header-content">
        <div class="logo-container">
          <img
            src="assets/img/logo-ecoRide.png"
            alt="Logo ecoCovoit"
            class="logo"
            width="50"
            height="50"
            loading="lazy"
          />
          <h1 class="app-title">ecoCovoit - Admin</h1>
        </div>
        <button
          id="menu-toggle"
          class="menu-toggle"
          aria-label="Ouvrir le menu principal"
          aria-expanded="false"
          aria-controls="main-nav"
          type="button"
        >
          <span class="hamburger-line" aria-hidden="true"></span>
          <span class="hamburger-line" aria-hidden="true"></span>
          <span class="hamburger-line" aria-hidden="true"></span>
        </button>

        <nav
          id="main-nav"
          class="main-nav"
          role="navigation"
          aria-label="Menu principal de navigation"
        >
          <ul class="nav-list">
            <!-- NAVIGATION ADMIN -->
            <li>
              <a href="admin-dashboard.html" class="nav-link"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
            <li>
              <a href="admin-comptes.html" class="nav-link"
                ><i class="fas fa-users"></i> Comptes</a
              >
            </li>
            <li>
              <a href="employe-avis.html" class="nav-link"
                ><i class="fas fa-star"></i> Avis</a
              >
            </li>
            <li>
              <a href="employe-incidents.html" class="nav-link active"
                ><i class="fas fa-exclamation-triangle"></i> Incidents</a
              >
            </li>
            <li>
              <a href="contact.html" class="nav-link"
                ><i class="fas fa-envelope"></i> Contact</a
              >
            </li>
            <li>
              <button
                class="nav-link logout-btn"
                onclick="logout()"
                type="button"
              >
                <i class="fas fa-sign-out-alt"></i> Déconnexion
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <!-- SECTION PRESENTATION -->
      <section class="presentation-section">
        <div class="presentation-content">
          <div class="text-content">
            <h2>Gestion des Incidents</h2>
            <p>
              <i class="fas fa-exclamation-triangle"></i> Support client et
              résolution des problèmes
            </p>
            <p>
              <i class="fas fa-headset"></i> Support 24/7<br />
              <i class="fas fa-clock"></i> Résolution rapide<br />
              <i class="fas fa-chart-line"></i> Suivi en temps réel<br />
              <i class="fas fa-users-cog"></i> Escalade automatique
            </p>
          </div>
          <div class="image-container">
            <div class="admin-hero-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>
      </section>

      <div class="admin-container">
        <!-- Statistiques -->
        <div class="stats-overview" id="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-value" id="stat-ouverts">-</div>
            <div class="stat-label">Incidents ouverts</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="stat-value" id="stat-en-cours">-</div>
            <div class="stat-label">En cours</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value" id="stat-resolus">-</div>
            <div class="stat-label">Résolus</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="stat-temps-moyen">-</div>
            <div class="stat-label">Temps moyen (h)</div>
          </div>
        </div>

        <!-- Filtres -->
        <div class="filters-panel">
          <div class="panel-header">
            <h3><i class="fas fa-filter"></i> Filtres de recherche</h3>
          </div>
          <div class="filters-grid">
            <div class="filter-group">
              <label for="filter-status"
                ><i class="fas fa-list"></i> Statut</label
              >
              <select id="filter-status" class="form-input">
                <option value="tous">Tous les statuts</option>
                <option value="ouvert" selected>Ouverts</option>
                <option value="en-cours">En cours</option>
                <option value="resolu">Résolus</option>
                <option value="ferme">Fermés</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-priority"
                ><i class="fas fa-flag"></i> Priorité</label
              >
              <select id="filter-priority" class="form-input">
                <option value="tous">Toutes les priorités</option>
                <option value="critique">Critique</option>
                <option value="haute">Haute</option>
                <option value="normale">Normale</option>
                <option value="basse">Basse</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-type"><i class="fas fa-tag"></i> Type</label>
              <select id="filter-type" class="form-input">
                <option value="tous">Tous les types</option>
                <option value="technique">Problème technique</option>
                <option value="paiement">Problème de paiement</option>
                <option value="comportement">Comportement inapproprié</option>
                <option value="autre">Autre</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-date-debut"
                ><i class="fas fa-calendar-alt"></i> Du</label
              >
              <input type="date" id="filter-date-debut" class="form-input" />
            </div>
          </div>
          <div class="search-actions">
            <button onclick="applyFilters()" class="btn btn-primary">
              <i class="fas fa-search"></i> Rechercher
            </button>
            <button onclick="resetFilters()" class="btn btn-secondary">
              <i class="fas fa-undo"></i> Réinitialiser
            </button>
            <button onclick="exportIncidents()" class="btn btn-success">
              <i class="fas fa-download"></i> Exporter
            </button>
          </div>
        </div>

        <!-- Liste des incidents -->
        <div id="incidents-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>Chargement des incidents...</p>
          </div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h3><i class="fas fa-car-side"></i> ecoCovoit</h3>
          <p>
            <i class="fas fa-seedling"></i> La plateforme de covoiturage
            écoresponsable
          </p>
          <p>
            <i class="fas fa-handshake"></i> Réduisons ensemble notre empreinte
            carbone
          </p>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-address-book"></i> Contact</h3>
          <p>
            <i class="fas fa-envelope"></i
            ><a href="mailto:contact@ecoride.fr"> contact@ecoride.fr</a>
          </p>
          <p><i class="fas fa-phone"></i> +33 1 23 45 67 89</p>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-info-circle"></i> Informations</h3>
          <ul>
            <li>
              <i class="fas fa-gavel"></i>
              <a href="mentions.html"> Mentions légales</a>
            </li>
            <li>
              <i class="fas fa-envelope"></i>
              <a href="contact.html"> Nous contacter</a>
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h3><i class="fas fa-share-alt"></i> Suivez-nous</h3>
          <div class="social-links">
            <a href="#" class="social-link" title="Facebook"
              ><i class="fab fa-facebook-f"></i
            ></a>
            <a href="#" class="social-link" title="Twitter"
              ><i class="fab fa-twitter"></i
            ></a>
            <a href="#" class="social-link" title="LinkedIn"
              ><i class="fab fa-linkedin-in"></i
            ></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 EcoRide. Tous droits réservés.</p>
        <p>
          <i class="fas fa-leaf"></i> Pour une mobilité plus verte
          <i class="fas fa-leaf text-green"></i>
        </p>
      </div>
    </footer>

    <script src="assets/js/menu.js"></script>
    <script>
      // État de l'application
      let allIncidents = [];
      let filteredIncidents = [];

      // Éléments du DOM
      const incidentsContainer = document.getElementById('incidents-container');
      const filterStatus = document.getElementById('filter-status');
      const filterPriority = document.getElementById('filter-priority');
      const filterType = document.getElementById('filter-type');
      const filterDateDebut = document.getElementById('filter-date-debut');

      // Chargement initial
      document.addEventListener('DOMContentLoaded', function () {
        loadIncidents();
      });

      // Chargement des incidents
      async function loadIncidents() {
        try {
          // Simulation des données d'incidents (à remplacer par l'API réelle)
          const mockData = {
            success: true,
            incidents: [
              {
                id: 1,
                type: 'technique',
                titre: 'Impossible de se connecter',
                description:
                  'Utilisateur ne peut pas se connecter malgré un mot de passe correct.',
                statut: 'ouvert',
                priorite: 'haute',
                utilisateur: 'Jean Dupont',
                email: 'jean.dupont@email.com',
                date_creation: '2025-01-06',
                date_mise_a_jour: '2025-01-06',
                assigne_a: null,
                responses: [],
              },
              {
                id: 2,
                type: 'paiement',
                titre: 'Problème de remboursement',
                description:
                  "Le remboursement du trajet annulé n'a pas été effectué.",
                statut: 'en-cours',
                priorite: 'normale',
                utilisateur: 'Marie Martin',
                email: 'marie.martin@email.com',
                date_creation: '2025-01-05',
                date_mise_a_jour: '2025-01-06',
                assigne_a: 'Support Tech',
                responses: [
                  {
                    auteur: 'Support Tech',
                    date: '2025-01-06',
                    message:
                      'Dossier pris en charge, vérification en cours avec la comptabilité.',
                  },
                ],
              },
            ],
            stats: {
              ouverts: 15,
              en_cours: 8,
              resolus: 142,
              temps_moyen: 24,
            },
          };

          allIncidents = mockData.incidents || [];
          updateStats(mockData.stats || {});
          applyFilters();
        } catch (error) {
          console.error('Erreur:', error);
          showError('Impossible de charger les incidents. Veuillez réessayer.');
        }
      }

      // Mise à jour des statistiques
      function updateStats(stats) {
        document.getElementById('stat-ouverts').textContent =
          stats.ouverts || 0;
        document.getElementById('stat-en-cours').textContent =
          stats.en_cours || 0;
        document.getElementById('stat-resolus').textContent =
          stats.resolus || 0;
        document.getElementById('stat-temps-moyen').textContent =
          stats.temps_moyen || 0;
      }

      // Application des filtres
      function applyFilters() {
        const statusFilter = filterStatus.value;
        const priorityFilter = filterPriority.value;
        const typeFilter = filterType.value;
        const dateDebutFilter = filterDateDebut.value;

        filteredIncidents = allIncidents.filter((incident) => {
          // Filtre par statut
          if (statusFilter !== 'tous' && incident.statut !== statusFilter) {
            return false;
          }

          // Filtre par priorité
          if (
            priorityFilter !== 'tous' &&
            incident.priorite !== priorityFilter
          ) {
            return false;
          }

          // Filtre par type
          if (typeFilter !== 'tous' && incident.type !== typeFilter) {
            return false;
          }

          // Filtre par date de début
          if (dateDebutFilter && incident.date_creation < dateDebutFilter) {
            return false;
          }

          return true;
        });

        renderIncidents();
      }

      // Réinitialisation des filtres
      function resetFilters() {
        filterStatus.value = 'ouvert';
        filterPriority.value = 'tous';
        filterType.value = 'tous';
        filterDateDebut.value = '';
        applyFilters();
      }

      // Rendu des incidents
      function renderIncidents() {
        if (filteredIncidents.length === 0) {
          incidentsContainer.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon"></div>
                        <h3>Aucun incident trouvé</h3>
                        <p>Aucun incident ne correspond à vos critères de recherche</p>
                    </div>
                `;
          return;
        }

        const incidentsHTML = filteredIncidents
          .map((incident) => createIncidentCard(incident))
          .join('');
        incidentsContainer.innerHTML = `<div class="incidents-container">${incidentsHTML}</div>`;
      }

      // Création d'une carte d'incident
      function createIncidentCard(incident) {
        const statusClass = `status-${incident.statut.replace('_', '-')}`;
        const priorityClass = `priority-${incident.priorite}`;
        const priorityIcon = getPriorityIcon(incident.priorite);

        return `
                <div class="incident-card">
                    <div class="incident-header">
                        <div class="incident-meta">
                            <div class="incident-type">
                                ${getTypeIcon(incident.type)} ${incident.titre}
                            </div>
                            <div class="incident-date">
                                Créé le ${formatDate(
                                  incident.date_creation
                                )} par ${incident.utilisateur}
                            </div>
                        </div>
                        <div>
                            <span class="incident-status ${statusClass}">
                                ${getStatusText(incident.statut)}
                            </span>
                            <span class="incident-priority ${priorityClass}">
                                ${priorityIcon} ${incident.priorite}
                            </span>
                        </div>
                    </div>

                    <div class="incident-content">
                        <div class="incident-description">
                            ${incident.description}
                        </div>

                        <div class="incident-details">
                            <div class="detail-item">
                                <span class="detail-icon"></span>
                                <span>${incident.utilisateur}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon"></span>
                                <span>${incident.email}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon"></span>
                                <span>${getTypeText(incident.type)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon"></span>
                                <span>${
                                  incident.assigne_a || 'Non assigné'
                                }</span>
                            </div>
                        </div>

                        ${
                          incident.responses && incident.responses.length > 0
                            ? createResponseHistory(incident.responses)
                            : ''
                        }
                    </div>

                    <div class="incident-actions">
                        ${generateActionButtons(incident)}
                    </div>

                    ${
                      incident.statut !== 'ferme'
                        ? generateResponseSection(incident.id)
                        : ''
                    }
                </div>
            `;
      }

      // Génération des boutons d'action
      function generateActionButtons(incident) {
        let buttons = [];

        if (incident.statut === 'ouvert') {
          buttons.push(`
                    <button onclick="takeIncident(${incident.id})" class="btn btn-primary">
                        Prendre en charge
                    </button>
                `);
        }

        if (incident.statut === 'en-cours') {
          buttons.push(`
                    <button onclick="resolveIncident(${incident.id})" class="btn btn-success">
                        Marquer comme résolu
                    </button>
                `);
        }

        if (incident.statut === 'resolu') {
          buttons.push(`
                    <button onclick="closeIncident(${incident.id})" class="btn btn-warning">
                        Fermer l'incident
                    </button>
                `);
        }

        buttons.push(`
                <button onclick="escalateIncident(${incident.id})" class="btn btn-danger">
                    Escalader
                </button>
            `);

        return buttons.join('');
      }

      // Section de réponse
      function generateResponseSection(incidentId) {
        return `
                <div class="response-section hidden" id="response-${incidentId}">
                    <h4>Répondre à l'incident</h4>
                    <textarea
                        id="response-text-${incidentId}"
                        class="response-textarea"
                        placeholder="Tapez votre réponse ici..."
                    ></textarea>
                    <div class="flex-gap">
                        <button onclick="sendResponse(${incidentId})" class="btn btn-primary">
                            Envoyer la réponse
                        </button>
                        <button onclick="hideResponseSection(${incidentId})" class="btn btn-warning">
                            Annuler
                        </button>
                    </div>
                </div>
            `;
      }

      // Historique des réponses
      function createResponseHistory(responses) {
        const responsesHTML = responses
          .map(
            (response) => `
                <div class="response-item">
                    <div class="response-meta">
                        <strong>${response.auteur}</strong>
                        <span>${formatDate(response.date)}</span>
                    </div>
                    <div>${response.message}</div>
                </div>
            `
          )
          .join('');

        return `
                <div class="response-history">
                    <h4>Historique des réponses</h4>
                    ${responsesHTML}
                </div>
            `;
      }

      // Actions sur les incidents
      async function takeIncident(incidentId) {
        if (!confirm('Prendre en charge cet incident ?')) {
          return;
        }

        try {
          // Simulation de la prise en charge
          const incident = allIncidents.find((i) => i.id === incidentId);
          if (incident) {
            incident.statut = 'en-cours';
            incident.assigne_a = 'Employé Support';
            applyFilters();
            alert('Incident pris en charge avec succès');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la prise en charge');
        }
      }

      async function resolveIncident(incidentId) {
        if (!confirm('Marquer cet incident comme résolu ?')) {
          return;
        }

        try {
          // Simulation de la résolution
          const incident = allIncidents.find((i) => i.id === incidentId);
          if (incident) {
            incident.statut = 'resolu';
            applyFilters();
            alert('Incident marqué comme résolu');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la résolution');
        }
      }

      async function closeIncident(incidentId) {
        if (!confirm('Fermer définitivement cet incident ?')) {
          return;
        }

        try {
          // Simulation de la fermeture
          const incident = allIncidents.find((i) => i.id === incidentId);
          if (incident) {
            incident.statut = 'ferme';
            applyFilters();
            alert('Incident fermé avec succès');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la fermeture');
        }
      }

      function escalateIncident(incidentId) {
        alert('Incident escaladé vers le niveau supérieur');
      }

      function showResponseSection(incidentId) {
        const section = document.getElementById(`response-${incidentId}`);
        if (section) {
          section.style.display = 'block';
          section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }

      function hideResponseSection(incidentId) {
        const section = document.getElementById(`response-${incidentId}`);
        if (section) {
          section.style.display = 'none';
        }
      }

      async function sendResponse(incidentId) {
        const responseText = document.getElementById(
          `response-text-${incidentId}`
        ).value;

        if (!responseText.trim()) {
          alert('Veuillez saisir une réponse');
          return;
        }

        try {
          // Simulation de l'envoi de réponse
          alert('Réponse envoyée avec succès');
          hideResponseSection(incidentId);

          // Ajouter la réponse à l'historique
          const incident = allIncidents.find((i) => i.id === incidentId);
          if (incident) {
            if (!incident.responses) incident.responses = [];
            incident.responses.push({
              auteur: 'Employé Support',
              date: new Date().toISOString(),
              message: responseText,
            });
            applyFilters();
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert("Erreur lors de l'envoi de la réponse");
        }
      }

      function exportIncidents() {
        alert('Export des incidents en cours...');
      }

      // Utilitaires
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function getStatusText(statut) {
        const statusTexts = {
          ouvert: 'Ouvert',
          'en-cours': 'En cours',
          resolu: 'Résolu',
          ferme: 'Fermé',
        };
        return statusTexts[statut] || statut;
      }

      function getTypeText(type) {
        const typeTexts = {
          technique: 'Problème technique',
          paiement: 'Problème de paiement',
          comportement: 'Comportement inapproprié',
          autre: 'Autre',
        };
        return typeTexts[type] || type;
      }

      function getTypeIcon(type) {
        const typeIcons = {
          technique: '🔧',
          paiement: '💳',
          comportement: '⚠️',
          autre: '❓',
        };
        return typeIcons[type] || '📝';
      }

      function getPriorityIcon(priority) {
        const priorityIcons = {
          critique: '🔴',
          haute: '🟡',
          normale: '🔵',
          basse: '🟢',
        };
        return priorityIcons[priority] || '⚪';
      }

      function showError(message) {
        incidentsContainer.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">❌</div>
                    <h3>Erreur</h3>
                    <p>${message}</p>
                    <button onclick="loadIncidents()" class="btn btn-primary">
                        🔄 Réessayer
                    </button>
                </div>
            `;
      }

      // Ajouter l'écouteur pour la section de réponse
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('incident-card')) {
          const incidentId = e.target.dataset.incidentId;
          if (incidentId) {
            showResponseSection(incidentId);
          }
        }
      });
    </script>
  </body>
</html>
